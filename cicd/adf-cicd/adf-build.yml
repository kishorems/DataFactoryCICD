parameters:
  - name: DataFactoryName
    type: string
  - name: ResourceGroupName
    type: string
  - name: ADFArtifactName
    type: string
  - name: WorkingDirectory
    type: string
steps:
  - checkout: self
    displayName: Checkout Source Repo Code
  - powershell: >
      Write-Host "Attempting to validate and build the ADF ARM template from
      Data Factory: ${{ parameters.DataFactoryName }} in resource group: ${{
      parameters.ResourceGroupName }}."
    displayName: Display The Build ADF Info
  - task: NodeTool@0
    displayName: Install Node.js
    inputs:
      versionSpec: 18.x
  - task: Npm@1
    displayName: Install NPM Package
    inputs:
      command: install
      workingDir: ${{ parameters.WorkingDirectory }}
      verbose: true
  - task: UsePythonVersion@0
    displayName: Use Python 3.x
    inputs:
      versionSpec: 3.x
  - script: |
      python -m pip install --upgrade pip
      pip install azure-cli
    displayName: Install Azure CLI
    
  # Install Azure CLI using AzureCLI@2 task
  - task: AzureCLI@2
    displayName: 'Install Azure CLI'
    inputs:
      azureSubscription: 'your-service-connection-name'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Azure CLI installed successfully"
        az --version
      
  - task: Npm@1
    displayName: Validate And Generate ADF ARM Template And Scripts
    inputs:
      command: custom
      workingDir: ${{ parameters.WorkingDirectory }}
      customCommand: run build export ${{ parameters.WorkingDirectory }}
        /subscriptions/$(DEVSubscriptionID)/resourceGroups/${{
        parameters.ResourceGroupName
        }}/providers/Microsoft.DataFactory/factories/${{
        parameters.DataFactoryName }} "ArmTemplate"
  - task: PublishPipelineArtifact@1
    displayName: Publish ADF ARM Template And Scripts
    inputs:
      targetPath: ${{ parameters.WorkingDirectory }}/ArmTemplate
      artifactName: ${{ parameters.ADFArtifactName }}
      publishLocation: pipeline
